#cloud-config
coreos:
  update:
    reboot-strategy: etcd-lock
    group: stable
  etcd2:
{% if bootstrap_cluster %}
    discovery: {{ discovery_token.content }}
{% else %}
    initial-cluster: {{ cluster_peers | join( ",") }}
    initial-cluster-state: existing
{% endif %}
{% if proxy %}
    proxy: on
{% else %}
    name: {{ vm }}
    listen-peer-urls: https://$private_ipv4:2380
    initial-advertise-peer-urls: https://$private_ipv4:2380
{% endif %}
    advertise-client-urls: https://$private_ipv4:2379
    listen-client-urls: https://127.0.0.1:2379,https://$private_ipv4:2379
    peer-cert-file: /home/core/etcd1.pem
    peer-key-file: /home/core/etcd1-key.pem
    peer-trusted-ca-file: /home/core/ca.pem
    cert-file: /home/core/etcd2.pem
    key-file: /home/core/etcd2-key.pem
    trusted-ca-file: /home/core/ca.pem
    heartbeat-interval: 250
    election-timeout: 2500
  fleet:
    etcd_servers: https://$private_ipv4:2379
    etcd_cafile: /home/core/ca.pem
    public_ip: $private_ipv4
    agent_ttl: "60s"
  locksmith:
    endpoint: https://127.0.0.1:2379
    etcd_cafile: /home/core/ca.pem
    etcd_certfile: /home/core/etcd2.pem
    etcd_keyfile: /home/core/etcd2-key.pem
  units:
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
    - name: fleet.service
      drop-ins:
        - name: 50-etcd_credentials.conf
          content: |
            [Service]
            Environment="FLEET_ETCD_USERNAME=root"
            Environment="FLEET_ETCD_PASSWORD={{ etcd_root_password }}"
    - name: fleet.socket
      drop-ins:
        - name: 10-root-only.conf
          content: |
            [Socket]
            SocketMode=0600
            SocketUser=root
            SocketGroup=root
    - name: myselinux.service
      command: start
      content: |
        [Unit]
        Description=Set SELinux enforcing

        [Service]
        Type=oneshot
        RemainAfterExit=true
        ExecStart=/usr/sbin/setenforce 1
        ExecStop=/usr/sbin/setenforce 0
write_files:
  - path: /home/core/etcd1.pem
    permissions: 0644
    content: |
      {{ lookup('file', 'etcd-tls/etcd1.pem') | indent(6, false) }}
  - path: /home/core/etcd1-key.pem
    permissions: 0644
    content: |
      {{ etcd1_key_pem | indent(6, false) }}
  - path: /home/core/etcd2.pem
    permissions: 0644
    content: |
      {{ lookup('file', 'etcd-tls/etcd2.pem') | indent(6, false) }}
  - path: /home/core/etcd2-key.pem
    permissions: 0644
    content: |
      {{ etcd2_key_pem | indent(6, false) }}
  - path: /home/core/ca.pem
    permissions: 0644
    content: |
      {{ lookup('file', 'etcd-tls/ca.pem') | indent(6, false) }}
  - path: /etc/selinux/config
    permissions: 644
    content: |
      SELINUX=enforcing
      SELINUXTYPE=mcs
ssh_authorized_keys:
{% for ssh_key in authorized_ssh_keys %}
  - {{ ssh_key }}
{% endfor %}
hostname: {{ vm }}
