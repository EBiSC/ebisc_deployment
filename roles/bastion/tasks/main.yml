- name: "copy unit file "
  become: yes
  copy:
    dest: "/etc/systemd/system/nginx.service"
    src: "nginx.service"

- name: Create project directory
  file:
    path: "/var/projects/ebisc"
    state: directory
    mode: "0750"
    owner: core
  become: yes

- name: copy files
  copy: "dest=/var/projects/ebisc/ src={{item}}"
  notify: restart nginx
  with_items:
    - Dockerfile-nginx
    - tls

- name: Create directory for letsencrypt ACME protocol
  file:
    path: "/var/projects/ebisc/www/.well-known"
    state: directory
    mode: "0770"
    owner: core
  become: yes

- name: copy tls private keys
  template:
    dest: "/var/projects/ebisc/tls/{{ item.name }}/privKey.pem"
    src: privKey.pem.j2
  with_items: "{{tls_keys}}"
  notify: restart nginx

- set_fact:
    tracker_ip: "{{hostvars[item].openstack.private_v4}}"
  with_items: "{{groups.tracker2}}"

- set_fact:
    ims_ip: "{{hostvars[item].openstack.private_v4}}"
  with_items: "{{groups.ims}}"

- set_fact:
    ims_staging_ip: "{{hostvars[item].openstack.private_v4}}"
  with_items: "{{groups.ims_staging}}"

- name: copy files
  template: dest=/var/projects/ebisc/nginx.conf src=nginx.conf.j2
- name: copy files
  template: dest=/var/projects/ebisc/htpasswd src=htpasswd.j2
  notify: restart nginx

- name: "enable unit"
  become: yes
  systemd:
    daemon_reload: yes
    enabled: yes
    name: "nginx.service"
    state: started

- name: build nginx image
  docker_image:
    path: /var/projects/ebisc
    dockerfile: Dockerfile-nginx
    name: ebisc/nginx
    state: present
    force: yes
  notify: restart nginx
